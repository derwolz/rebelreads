<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Object Storage Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .test-section {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 30px;
      background-color: #f8f9fa;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
      background-color: #fff;
    }
    .image-preview {
      margin-top: 20px;
      max-width: 300px;
      max-height: 300px;
      border: 1px solid #ddd;
      padding: 5px;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .book-test {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background-color: #fff;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      background-color: #e9ecef;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Object Storage Testing</h1>
    <span class="tag">Test Environment</span>
  </div>
  
  <!-- Profile Image Upload Test -->
  <div class="test-section">
    <h2>1. Profile Image Upload Test</h2>
    <p>Tests uploading a profile image to the object storage via the user profile API.</p>
    
    <div class="form-group">
      <label for="profileImage">Select a profile image:</label>
      <input type="file" id="profileImage" accept="image/*">
    </div>
    
    <button id="uploadProfileButton">Upload Profile Image</button>
    
    <div id="profileResult" class="result">
      <p>Results will appear here...</p>
    </div>
  </div>
  
  <!-- Book Cover Upload Test -->
  <div class="test-section">
    <h2>2. Book Cover Upload Test</h2>
    <p>Tests uploading book cover images with different types.</p>
    
    <div class="form-group">
      <label for="bookCover">Select a book cover image:</label>
      <input type="file" id="bookCover" accept="image/*">
    </div>
    
    <div class="form-group">
      <label>Image type:</label>
      <select id="coverType">
        <option value="book-detail">book-detail</option>
        <option value="background">background</option>
        <option value="book-card">book-card</option>
        <option value="grid-item">grid-item</option>
        <option value="mini">mini</option>
        <option value="hero">hero</option>
      </select>
    </div>
    
    <button id="uploadCoverButton">Upload Book Cover</button>
    
    <div id="bookResult" class="result">
      <p>Results will appear here...</p>
    </div>
  </div>
  
  <!-- Direct Object Storage Test -->
  <div class="test-section">
    <h2>3. Multiple Book Images Upload Test</h2>
    <p>Tests uploading multiple book images at once using the publisher API.</p>
    
    <div class="form-group">
      <label for="bookTitle">Book Title:</label>
      <input type="text" id="bookTitle" value="Test Book">
    </div>
    
    <div class="form-group">
      <label for="bookDescription">Book Description:</label>
      <textarea id="bookDescription" rows="3">This is a test book description for the object storage test.</textarea>
    </div>
    
    <div class="test-grid">
      <div class="book-test">
        <label>Book Detail Image:</label>
        <input type="file" class="bookImage" data-type="book_detail" accept="image/*">
      </div>
      
      <div class="book-test">
        <label>Background Image:</label>
        <input type="file" class="bookImage" data-type="background" accept="image/*">
      </div>
      
      <div class="book-test">
        <label>Book Card Image:</label>
        <input type="file" class="bookImage" data-type="book_card" accept="image/*">
      </div>
      
      <div class="book-test">
        <label>Grid Item Image:</label>
        <input type="file" class="bookImage" data-type="grid_item" accept="image/*">
      </div>
      
      <div class="book-test">
        <label>Mini Image:</label>
        <input type="file" class="bookImage" data-type="mini" accept="image/*">
      </div>
      
      <div class="book-test">
        <label>Hero Image:</label>
        <input type="file" class="bookImage" data-type="hero" accept="image/*">
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <button id="uploadMultipleButton">Upload All Book Images</button>
    </div>
    
    <div id="multipleResult" class="result">
      <p>Results will appear here...</p>
    </div>
  </div>

  <script>
    // Profile Image Upload Test
    document.getElementById('uploadProfileButton').addEventListener('click', async () => {
      const resultDiv = document.getElementById('profileResult');
      resultDiv.innerHTML = '<p>Uploading profile image...</p>';
      
      const fileInput = document.getElementById('profileImage');
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.innerHTML = '<p style="color: red;">Please select a file first</p>';
        return;
      }
      
      const file = fileInput.files[0];
      
      try {
        // Create form data
        const formData = new FormData();
        formData.append('profileImage', file);
        
        // Send the upload request
        const response = await fetch('/api/user/profile-image', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Profile upload result:', result);
        
        // Display result
        let html = `
          <h3>Upload Successful!</h3>
          <p>Image URL: ${result.profileImageUrl}</p>
        `;
        
        // Add image preview
        html += `
          <h3>Image Preview:</h3>
          <img src="${result.profileImageUrl}" class="image-preview" alt="Uploaded image">
        `;
        
        resultDiv.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    });
    
    // Book Cover Upload Test
    document.getElementById('uploadCoverButton').addEventListener('click', async () => {
      const resultDiv = document.getElementById('bookResult');
      resultDiv.innerHTML = '<p>Uploading book cover...</p>';
      
      const fileInput = document.getElementById('bookCover');
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.innerHTML = '<p style="color: red;">Please select a file first</p>';
        return;
      }
      
      const file = fileInput.files[0];
      const coverType = document.getElementById('coverType').value;
      
      try {
        // Create form data
        const formData = new FormData();
        formData.append(`bookImage_${coverType}`, file);
        formData.append('bookId', '1'); // Using a test book ID
        
        // Send the upload request
        const response = await fetch('/api/books/update-image', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Book cover upload result:', result);
        
        // Display result
        let html = `
          <h3>Upload Successful!</h3>
          <p>Image URL: ${result.imageUrl}</p>
          <p>Image Type: ${result.imageType}</p>
        `;
        
        // Add image preview
        html += `
          <h3>Image Preview:</h3>
          <img src="${result.imageUrl}" class="image-preview" alt="Uploaded cover">
        `;
        
        resultDiv.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    });
    
    // Multiple Book Images Upload Test
    document.getElementById('uploadMultipleButton').addEventListener('click', async () => {
      const resultDiv = document.getElementById('multipleResult');
      resultDiv.innerHTML = '<p>Uploading multiple book images...</p>';
      
      // Get all file inputs
      const fileInputs = document.querySelectorAll('.bookImage');
      let hasFiles = false;
      
      // Create form data
      const formData = new FormData();
      
      // Add each file to the form data
      fileInputs.forEach(input => {
        if (input.files && input.files.length > 0) {
          const fileType = input.getAttribute('data-type');
          formData.append(fileType, input.files[0]);
          hasFiles = true;
        }
      });
      
      if (!hasFiles) {
        resultDiv.innerHTML = '<p style="color: red;">Please select at least one file to upload</p>';
        return;
      }
      
      // Add book data
      const bookData = {
        title: document.getElementById('bookTitle').value,
        description: document.getElementById('bookDescription').value,
        authorId: 1, // Using a test author ID
        pageCount: 100,
        formats: ["ebook", "paperback"],
        language: "English"
      };
      
      formData.append('books', JSON.stringify([bookData]));
      
      try {
        // Send the upload request
        const response = await fetch('/api/catalogue/publishers/books', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        console.log('Multiple upload result:', result);
        
        if (!response.ok) {
          throw new Error(`Upload failed: ${response.statusText} - ${JSON.stringify(result)}`);
        }
        
        // Display result
        let html = `<h3>Upload Results:</h3>`;
        
        if (result.success) {
          html += `<p style="color: green;">Successfully created ${result.createdBooks.length} book(s)</p>`;
          
          // Show created books with images
          result.createdBooks.forEach(book => {
            html += `
              <div style="margin-top: 15px; padding: 10px; border: 1px solid #ddd;">
                <h4>${book.title}</h4>
                <p>Book ID: ${book.id}</p>
                <p>Images: ${book.images.length}</p>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            `;
            
            // Show images
            book.images.forEach(image => {
              html += `
                <div style="text-align: center;">
                  <img src="${image.imageUrl}" alt="${image.imageType}" style="max-width: 150px; max-height: 150px; margin-bottom: 5px;">
                  <div style="font-size: 12px;">${image.imageType}</div>
                </div>
              `;
            });
            
            html += `</div></div>`;
          });
        } else {
          html += `<p style="color: red;">Upload failed: ${result.message || 'Unknown error'}</p>`;
          
          if (result.errors && result.errors.length > 0) {
            html += `<p>Errors:</p><ul>`;
            result.errors.forEach(err => {
              html += `<li>${err.error}</li>`;
            });
            html += `</ul>`;
          }
        }
        
        resultDiv.innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>